// PlannerApp/Views/Settings/SettingsView.swift
// (Create a new folder Views/Settings if needed)

import SwiftUI
import UserNotifications // Needed for notification settings
import LocalAuthentication // Needed for Face ID/Touch ID
import AppKit // Needed for NSWorkspace
import CloudKit // Needed for CloudKit integration
import Foundation

struct SettingsView: View {
    // Environment Object to access the shared ThemeManager instance
    @EnvironmentObject var themeManager: ThemeManager
    @StateObject private var cloudKit = CloudKitManager.shared
    @StateObject private var accessibilityManager = AccessibilityManager()

    // --- AppStorage properties to bind UI controls directly to UserDefaults ---
    @AppStorage(AppSettingKeys.userName) private var userName: String = ""
    @AppStorage(AppSettingKeys.dashboardItemLimit) private var dashboardItemLimit: Int = 3
    // This binds the Picker selection to UserDefaults. ThemeManager observes this key.
    @AppStorage(AppSettingKeys.themeColorName) private var selectedThemeName: String = Theme.defaultTheme.name

    // Notification Settings
    @AppStorage(AppSettingKeys.notificationsEnabled) private var notificationsEnabled: Bool = true
    @AppStorage(AppSettingKeys.defaultReminderTime) private var defaultReminderTime: Double = 3600 // Default 1 hour

    // Date & Time Settings
    @AppStorage(AppSettingKeys.firstDayOfWeek) private var firstDayOfWeek: Int = Calendar.current.firstWeekday
    @AppStorage(AppSettingKeys.use24HourTime) private var use24HourTime: Bool = false

    // App Behavior Settings
    @AppStorage(AppSettingKeys.autoDeleteCompleted) private var autoDeleteCompleted: Bool = false
    @AppStorage(AppSettingKeys.autoDeleteDays) private var autoDeleteDays: Int = 30
    @AppStorage(AppSettingKeys.defaultView) private var defaultView: String = "Dashboard" // Default tab name

    // Journal Security
    @AppStorage(AppSettingKeys.journalBiometricsEnabled) private var journalBiometricsEnabled: Bool = false

    // --- State for managing UI elements like alerts and sheets ---
    @State private var showingNotificationAlert = false
    @State private var showingClearDataConfirmation = false
    @State private var showingExportShareSheet = false
    @State private var exportURL: URL? // URL of the temporary file to share
    
    // New state variables for enhanced features
    @State private var showingCloudKitSheet = false
    @State private var showingThemePreview = false
    
    // Additional settings using AppSettingKeys
    @AppStorage(AppSettingKeys.autoSyncEnabled) private var autoSyncEnabled: Bool = true
    @AppStorage(AppSettingKeys.syncFrequency) private var syncFrequency: String = "hourly"
    @AppStorage(AppSettingKeys.enableHapticFeedback) private var enableHapticFeedback: Bool = true
    @AppStorage(AppSettingKeys.enableAnalytics) private var enableAnalytics: Bool = false

    // --- Options for Pickers ---
    // Dictionary mapping display names to TimeInterval values for reminder options
    let reminderTimeOptions: [String: Double] = [
        "None": 0, "At time of event": 1, "5 minutes before": 300,
        "15 minutes before": 900, "30 minutes before": 1800, "1 hour before": 3600,
        "1 day before": 86400
    ]
    // Computed property to get sorted keys for the Picker, ensuring consistent order
    var sortedReminderKeys: [String] {
        reminderTimeOptions.keys.sorted { reminderTimeOptions[$0]! < reminderTimeOptions[$1]! }
    }
    // Options for the default view picker, matching the tab names/tags
    let defaultViewOptions = ["Dashboard", "Tasks", "Calendar", "Goals", "Journal"]

    // --- Biometric Check ---
    // Computed property to check if device supports biometrics
    var canUseBiometrics: Bool {
        let context = LAContext()
        var error: NSError?
        // Check if the device can evaluate the policy for biometric authentication
        return context.canEvaluatePolicy(.deviceOwnerAuthenticationWithBiometrics, error: &error)
    }

    var body: some View {
        NavigationView {
            Form {
                // --- Profile Section ---
                Section("Profile") {
                    HStack {
                        Text("Name")
                            // Apply theme font and color
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.secondaryFontName, size: 16))
                            .foregroundColor(themeManager.currentTheme.secondaryTextColor)
                        TextField("Enter your name", text: $userName)
                            .multilineTextAlignment(.trailing)
                            // Apply theme font and color
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                            .foregroundColor(themeManager.currentTheme.primaryTextColor)
                    }
                }
                // Apply themed background to the list row
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)

                // --- Appearance Section ---
                Section("Appearance") {
                    // Picker bound to `selectedThemeName`, which updates UserDefaults via @AppStorage
                    Picker("Theme", selection: $selectedThemeName) {
                        // Use the static list of names from ThemeManager
                        ForEach(ThemeManager.availableThemeNames, id: \.self) { name in
                            Text(name).tag(name)
                        }
                    }
                    // Apply theme font
                    .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)

                // --- Dashboard Section ---
                Section("Dashboard") {
                    // Stepper bound to `dashboardItemLimit` (updates UserDefaults)
                    Stepper("Items per section: \(dashboardItemLimit)", value: $dashboardItemLimit, in: 1...10)
                        .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)

                // --- Notifications Section ---
                Section("Notifications") {
                    // Toggle bound to `notificationsEnabled` (updates UserDefaults)
                    Toggle("Enable Reminders", isOn: $notificationsEnabled)
                        // Request permission when toggled on
                        .onChange(of: notificationsEnabled) { _, newValue in
                            handleNotificationToggle(enabled: newValue)
                        }
                        // Show alert if permission was denied
                        .alert("Notification Permissions", isPresented: $showingNotificationAlert, actions: notificationAlertActions)
                        .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))

                    // Picker bound to `defaultReminderTime` (updates UserDefaults)
                    Picker("Default Reminder", selection: $defaultReminderTime) {
                        ForEach(sortedReminderKeys, id: \.self) { key in
                            Text(key).tag(reminderTimeOptions[key]!)
                        }
                    }
                    .disabled(!notificationsEnabled) // Disable picker if reminders are off
                    .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)

                // --- Date & Time Section ---
                Section("Date & Time") {
                    // Picker bound to `firstDayOfWeek` (updates UserDefaults)
                    Picker("First Day of Week", selection: $firstDayOfWeek) {
                        // Map display names to Calendar weekday integers
                        Text("System Default").tag(Calendar.current.firstWeekday)
                        Text("Sunday").tag(1)
                        Text("Monday").tag(2)
                    }
                    .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))

                    // Toggle bound to `use24HourTime` (updates UserDefaults)
                    Toggle("Use 24-Hour Time", isOn: $use24HourTime)
                        .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)

                // --- App Behavior Section ---
                Section("App Behavior") {
                     // Picker bound to `defaultView` (updates UserDefaults)
                     Picker("Default View on Launch", selection: $defaultView) {
                         ForEach(defaultViewOptions, id: \.self) { viewName in
                             Text(viewName).tag(viewName)
                         }
                     }
                     .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))

                    // Toggle bound to `autoDeleteCompleted` (updates UserDefaults)
                    Toggle("Auto-Delete Completed Tasks", isOn: $autoDeleteCompleted)
                        .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                    // Show Stepper only if auto-delete is enabled
                    if autoDeleteCompleted {
                        Stepper("Delete after: \(autoDeleteDays) days", value: $autoDeleteDays, in: 1...90)
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                    }
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)

                 // --- Security Section ---
                 Section("Security") {
                     // Only show toggle if biometrics are available
                     if canUseBiometrics {
                         Toggle("Protect Journal with Biometrics", isOn: $journalBiometricsEnabled)
                             .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                     } else {
                         // Inform user if biometrics aren't usable
                         Text("Biometric authentication not available on this device.")
                             .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.secondaryFontName, size: 14))
                             .foregroundColor(themeManager.currentTheme.secondaryTextColor)
                     }
                 }
                 .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)


                // --- Data Management Section ---
                Section("Data Management") {
                    // Button to trigger data export
                    Button("Export Data", action: exportData)
                        .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16, weight: .medium))
                        .foregroundColor(themeManager.currentTheme.primaryAccentColor)
                        // Presents a share sheet when `showingExportShareSheet` is true and `exportURL` is set
                        .sheet(isPresented: $showingExportShareSheet) {
                            if let url = exportURL {
                                ActivityViewController(activityItems: [url]) // Use wrapper for UIActivityViewController
                            }
                        }

                    // Button to trigger confirmation alert for clearing data
                    Button("Clear Old Completed Tasks...", action: { showingClearDataConfirmation = true })
                        .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16, weight: .medium))
                        .foregroundColor(themeManager.currentTheme.destructiveColor) // Use destructive color
                        // Confirmation alert before performing deletion
                        .alert("Confirm Deletion", isPresented: $showingClearDataConfirmation) {
                            Button("Delete", role: .destructive, action: performClearOldData) // Destructive action
                            Button("Cancel", role: .cancel) {} // Cancel action
                        } message: {
                            // Informative message for the alert
                            Text("Are you sure you want to permanently delete completed tasks older than \(autoDeleteDays) days? This cannot be undone.")
                        }
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)

                // --- Sync & Cloud Section ---
                Section("Sync & Cloud") {
                    Button(action: { showingCloudKitSheet = true }) {
                        HStack {
                            Image(systemName: cloudKit.isSignedInToiCloud ? "icloud.fill" : "icloud.slash")
                                .foregroundColor(cloudKit.isSignedInToiCloud ? .green : .red)
                            Text("iCloud Sync")
                                .foregroundColor(themeManager.currentTheme.primaryTextColor)
                            Spacer()
                            if cloudKit.syncStatus == .syncing {
                                ProgressView()
                                    .scaleEffect(0.8)
                            }
                            Image(systemName: "chevron.right")
                                .foregroundColor(themeManager.currentTheme.secondaryTextColor)
                        }
                    }
                    
                    if cloudKit.isSignedInToiCloud {
                        Toggle("Auto Sync", isOn: $autoSyncEnabled)
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                        
                        Picker("Sync Frequency", selection: $syncFrequency) {
                            Text("Every 15 minutes").tag("15min")
                            Text("Hourly").tag("hourly")
                            Text("Daily").tag("daily")
                            Text("Manual only").tag("manual")
                        }
                        .disabled(!autoSyncEnabled)
                        .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                    }
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)
                .sheet(isPresented: $showingCloudKitSheet) {
                    CloudKitSyncView()
                        .environmentObject(themeManager)
                }

                // --- Enhanced Appearance Section ---
                Section("Enhanced Appearance") {
                    Button(action: { showingThemePreview = true }) {
                        HStack {
                            Text("Theme Preview")
                                .foregroundColor(themeManager.currentTheme.primaryTextColor)
                            Spacer()
                            Circle()
                                .fill(themeManager.currentTheme.primaryAccentColor)
                                .frame(width: 20, height: 20)
                            Image(systemName: "chevron.right")
                                .foregroundColor(themeManager.currentTheme.secondaryTextColor)
                        }
                    }
                    
                    Toggle("Haptic Feedback", isOn: $enableHapticFeedback)
                        .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)
                .sheet(isPresented: $showingThemePreview) {
                    ThemePreviewView()
                        .environmentObject(themeManager)
                }

                // --- Accessibility Section ---
                Section("Accessibility") {
                    HStack {
                        Text("VoiceOver")
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.secondaryFontName, size: 16))
                        Spacer()
                        Text(accessibilityManager.isVoiceOverEnabled ? "Active" : "Inactive")
                            .foregroundColor(accessibilityManager.isVoiceOverEnabled ? .green : themeManager.currentTheme.secondaryTextColor)
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.secondaryFontName, size: 16))
                    }
                    
                    HStack {
                        Text("Dynamic Type")
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.secondaryFontName, size: 16))
                        Spacer()
                        Text(accessibilityManager.prefersDynamicType ? "Large Text" : "Standard")
                            .foregroundColor(themeManager.currentTheme.secondaryTextColor)
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.secondaryFontName, size: 16))
                    }
                    
                    HStack {
                        Text("Reduced Motion")
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.secondaryFontName, size: 16))
                        Spacer()
                        Text(accessibilityManager.prefersReducedMotion ? "Enabled" : "Disabled")
                            .foregroundColor(themeManager.currentTheme.secondaryTextColor)
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.secondaryFontName, size: 16))
                    }
                    
                    Button("Open Accessibility Settings") {
                        if let url = URL(string: "x-apple.systempreferences:com.apple.preference.universalaccess") {
                            NSWorkspace.shared.open(url)
                        }
                    }
                    .foregroundColor(themeManager.currentTheme.primaryAccentColor)
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)

                // --- Privacy Section ---
                Section("Privacy") {
                    Toggle("Enable Analytics", isOn: $enableAnalytics)
                        .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.primaryFontName, size: 16))
                    
                    if enableAnalytics {
                        Text("Help improve PlannerApp by sharing anonymous usage data.")
                            .font(.caption)
                            .foregroundColor(themeManager.currentTheme.secondaryTextColor)
                    }
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)

                // --- About Section ---
                Section("About") {
                    HStack {
                        Text("App Version")
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.secondaryFontName, size: 16))
                        Spacer()
                        Text(Bundle.main.appVersion ?? "N/A") // Use helper extension
                            .foregroundColor(themeManager.currentTheme.secondaryTextColor)
                            .font(themeManager.currentTheme.font(forName: themeManager.currentTheme.secondaryFontName, size: 16))
                    }
                }
                .listRowBackground(themeManager.currentTheme.secondaryBackgroundColor)

            } // End Form
            .navigationTitle("Settings")
            // Apply theme background color to the Form itself
            .background(themeManager.currentTheme.primaryBackgroundColor.ignoresSafeArea())
            // Hide the default Form background style to let the view background show through
            .scrollContentBackground(.hidden)
            // Apply theme text color globally within the form (affects section headers)
            .foregroundColor(themeManager.currentTheme.primaryTextColor)
             // Set the accent color for interactive elements within the Form
            .accentColor(themeManager.currentTheme.primaryAccentColor)

        } // End NavigationView
        // Apply theme accent color to the NavigationView (affects back button, etc.)
        .accentColor(themeManager.currentTheme.primaryAccentColor)
    }

    // --- Action Handlers ---

    // Handles the logic when the notification toggle changes state
    func handleNotificationToggle(enabled: Bool) {
        if enabled {
            // If toggled on, request permission from the user
            requestNotificationPermission()
        }
        // TODO: Add logic here to schedule/cancel existing notifications based on this toggle
        print("Notification toggle changed: \(enabled)")
    }

    // Builds the buttons for the notification permission alert
    @ViewBuilder
    func notificationAlertActions() -> some View {
         // Button to open the app's settings in the Settings app
         Button("Open Settings", action: openAppSettings)
         // Standard cancel button
         Button("Cancel", role: .cancel) {}
    }

    // Requests authorization from the user to send notifications
    func requestNotificationPermission() {
        UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .badge, .sound]) { granted, error in
            // Handle the response on the main thread
            DispatchQueue.main.async {
                if !granted {
                    // If permission denied, show the alert prompting user to go to settings
                    self.showingNotificationAlert = true
                    // Turn the toggle back off since permission wasn't granted
                    self.notificationsEnabled = false
                }
                // Log any errors during the request
                if let error = error {
                     print("Notification permission error: \(error.localizedDescription)")
                     self.notificationsEnabled = false // Also turn off if error occurred
                }
            }
        }
    }

     // Opens the app's settings using macOS system preferences
     func openAppSettings() {
         guard let url = URL(string: "x-apple.systempreferences:com.apple.preference.security?Privacy_Notifications") else {
             print("Cannot open system preferences URL.")
             return
         }
         NSWorkspace.shared.open(url)
     }

    // Prepares data and triggers the share sheet presentation
    func exportData() {
        print("Export Data action triggered")
        // 1. Load all relevant data (combine tasks, events, goals, journal entries)
        let tasks = TaskDataManager.shared.load()
        let events = CalendarDataManager.shared.load()
        let goals = GoalDataManager.shared.load()
        // TODO: Add Journal export if desired

        // 2. Convert data to a shareable format (e.g., CSV)
        guard let csvString = generateCSV(tasks: tasks, events: events, goals: goals),
              let data = csvString.data(using: .utf8) else {
            print("Failed to generate export data")
            // TODO: Show user-facing error alert
            return
        }

        // 3. Save data to a temporary file
        let tempURL = FileManager.default.temporaryDirectory.appendingPathComponent("PlannerExport.csv")
        do {
            try data.write(to: tempURL, options: .atomic) // Use atomic write for safety
            self.exportURL = tempURL // Store the URL of the file to be shared
            self.showingExportShareSheet = true // Set state to present the sheet
            print("Export file created at: \(tempURL)")
        } catch {
            print("Failed to write export file: \(error)")
            // TODO: Show user-facing error alert
        }
    }

    // Generates a single CSV string from multiple data types (example)
    func generateCSV(tasks: [Task], events: [CalendarEvent], goals: [Goal]) -> String? {
        var csv = "Type,ID,Title,Description/Status,Date\n" // Header

        // Add Tasks
        for task in tasks {
            let status = task.isCompleted ? "Completed" : "Pending"
            let title = escapeCSVField(task.title)
            csv += "Task,\(task.id.uuidString),\"\(title)\",\(status),\n" // No date for tasks in this model
        }
        // Add Events
        for event in events {
             let title = escapeCSVField(event.title)
             let date = escapeCSVField(event.date.ISO8601Format()) // Use ISO format for dates
             csv += "Event,\(event.id.uuidString),\"\(title)\",,\"\(date)\"\n" // No description field
        }
        // Add Goals
        for goal in goals {
             let title = escapeCSVField(goal.title)
             let desc = escapeCSVField(goal.description)
             let date = escapeCSVField(goal.targetDate.ISO8601Format())
             csv += "Goal,\(goal.id.uuidString),\"\(title)\",\"\(desc)\",\"\(date)\"\n"
        }
        return csv
    }

    // Helper function to escape characters potentially problematic in CSV (quotes)
    func escapeCSVField(_ field: String) -> String {
        return field.replacingOccurrences(of: "\"", with: "\"\"")
    }

    // Performs the actual deletion of old completed tasks after confirmation
    func performClearOldData() {
        print("Performing clear old data...")
        // 1. Load current tasks
        var tasks = TaskDataManager.shared.load()
        let initialCount = tasks.count

        // 2. Determine the cutoff date based on settings
        guard let cutoffDate = Calendar.current.date(byAdding: .day, value: -autoDeleteDays, to: Date()) else {
            print("Could not calculate cutoff date for deletion.")
            // TODO: Show user-facing error alert
            return
        }
        print("Cutoff date for deletion: \(cutoffDate)")

        // 3. Filter out tasks to keep
        // IMPORTANT: This requires the Task model to have a `completionDate: Date?` property.
        // If it doesn't, this deletion logic will not work as intended.
        tasks.removeAll { task in
            // Ensure the task is completed and has a completion date
            guard task.isCompleted /*, let completionDate = task.completionDate */ else {
                return false // Keep incomplete tasks or those missing completionDate
            }
            // *** Uncomment the line above and ensure Task model has `completionDate` ***
            // *** Placeholder logic if completionDate is missing: ***
            // This placeholder simply checks if the task is completed, it doesn't check the date.
            // return true // This would delete ALL completed tasks if uncommented without date check.
             print("Warning: Task model needs 'completionDate' for accurate deletion. Skipping date check.")
             return false // Keep all tasks if completionDate is missing to prevent accidental deletion
            // *** End Placeholder ***

            // Remove the task if its completion date is before the cutoff date
            // return completionDate < cutoffDate
        }

        // 4. Save only if tasks were actually removed
        if tasks.count < initialCount {
            TaskDataManager.shared.save(tasks: tasks)
            print("Cleared \(initialCount - tasks.count) old completed tasks.")
            // TODO: Show user-facing success message
        } else {
            print("No old completed tasks found to clear (or Task.completionDate is missing).")
            // TODO: Show user-facing message indicating nothing was deleted
        }
    }
}

// --- ActivityViewController Wrapper ---
// Allows using macOS NSSharingService for sharing functionality
struct ActivityViewController: NSViewRepresentable {
    var activityItems: [Any] // Items to share (e.g., text, URLs, images)
    
    func makeNSView(context: Context) -> NSView {
        let view = NSView()
        return view
    }
    
    func updateNSView(_ nsView: NSView, context: Context) {
        // Trigger sharing when view updates
        DispatchQueue.main.async {
            if let window = nsView.window,
               let firstItem = activityItems.first {
                let sharingService = NSSharingService(named: .composeEmail)
                sharingService?.perform(withItems: [firstItem])
            }
        }
    }
}


// --- Helper extension for getting App Version ---
extension Bundle {
    var appVersion: String? {
        // Reads "CFBundleShortVersionString" from the app's Info.plist
        self.infoDictionary?["CFBundleShortVersionString"] as? String
    }
}

// --- Preview Provider ---
struct SettingsView_Previews: PreviewProvider {
    static var previews: some View {
        // Provide the ThemeManager environment object for the preview to work
        SettingsView()
            .environmentObject(ThemeManager())
    }
}
