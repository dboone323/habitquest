name: iOS App Store Deployment

on:
  push:
    tags:
      - 'ios-v*'
  workflow_dispatch:
    inputs:
      project:
        description: 'Project to deploy'
        required: true
        default: 'AvoidObstaclesGame'
        type: choice
        options:
          - AvoidObstaclesGame
          - PlannerApp
          - MomentumFinance
          - HabitQuest
      environment:
        description: 'Deployment environment'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - production

jobs:
  deploy-ios:
    name: Deploy iOS App
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install fastlane
        run: |
          gem install fastlane

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Set project path
        id: project-path
        run: |
          case "${{ github.event.inputs.project || 'AvoidObstaclesGame' }}" in
            AvoidObstaclesGame)
              echo "path=Projects/AvoidObstaclesGame" >> $GITHUB_OUTPUT
              ;;
            PlannerApp)
              echo "path=Projects/PlannerApp" >> $GITHUB_OUTPUT
              ;;
            MomentumFinance)
              echo "path=Projects/MomentumFinance" >> $GITHUB_OUTPUT
              ;;
            HabitQuest)
              echo "path=Projects/HabitQuest" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Create App Store Connect API Key
        run: |
          mkdir -p ${{ steps.project-path.outputs.path }}/fastlane
          cat > ${{ steps.project-path.outputs.path }}/fastlane/api_key.json << EOF
          {
            "key_id": "${{ secrets.APP_STORE_CONNECT_KEY_ID }}",
            "issuer_id": "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}",
            "key": "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}",
            "duration": 1200,
            "in_house": false
          }
          EOF

      - name: Create Appfile
        run: |
          cd ${{ steps.project-path.outputs.path }}
          cat > fastlane/Appfile << EOF
          app_identifier("${{ secrets.APP_IDENTIFIER }}")
          apple_id("${{ secrets.APPLE_ID }}")
          team_id("${{ secrets.TEAM_ID }}")
          itc_team_id("${{ secrets.TEAM_ID }}")
          EOF

      - name: Run tests
        run: |
          cd ${{ steps.project-path.outputs.path }}
          fastlane test

      - name: Deploy to TestFlight
        if: github.event.inputs.environment == 'testflight' || startsWith(github.ref, 'refs/tags/')
        run: |
          cd ${{ steps.project-path.outputs.path }}
          fastlane beta

      - name: Deploy to Production
        if: github.event.inputs.environment == 'production'
        run: |
          cd ${{ steps.project-path.outputs.path }}
          fastlane release

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs-${{ github.event.inputs.project || 'AvoidObstaclesGame' }}
          path: |
            ${{ steps.project-path.outputs.path }}/fastlane/build_output/
            ${{ steps.project-path.outputs.path }}/fastlane/test_output/